#!/usr/bin/env node
const fs = require('fs')
const path = require('path')
let fetchLib
try {
  fetchLib = globalThis.fetch ? globalThis.fetch.bind(globalThis) : require('node-fetch')
} catch (err) {
  // If node-fetch isn't installed and global fetch isn't available, show a helpful error later
  fetchLib = null
}

async function main() {
  const lcovPath = path.resolve(process.cwd(), 'coverage/lcov.info')
  if (!fs.existsSync(lcovPath)) {
    console.log('No lcov.info found; skipping coverage comment')
    return
  }

  const data = fs.readFileSync(lcovPath, 'utf8')
  const lines = data.split('\n')
  let totalLF = 0
  let totalLH = 0
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i]
    if (line.startsWith('LF:')) totalLF += parseInt(line.split(':')[1], 10)
    if (line.startsWith('LH:')) totalLH += parseInt(line.split(':')[1], 10)
  }

  const pct = totalLF === 0 ? 0 : Math.round((totalLH / totalLF) * 10000) / 100
  const body = `<!-- coverage-report -->\n**Coverage summary**: ${pct}% (lines)\n\nGenerated by workflow run: ${process.env.GITHUB_RUN_ID || 'local'}`

  const token = process.env.GITHUB_TOKEN
  if (!token) {
    console.log('GITHUB_TOKEN missing; cannot post coverage comment')
    console.log(body)
    return
  }

  const eventPath = process.env.GITHUB_EVENT_PATH
  let prNumber = null
  if (eventPath && fs.existsSync(eventPath)) {
    const event = JSON.parse(fs.readFileSync(eventPath, 'utf8'))
    prNumber = event.pull_request && event.pull_request.number
  }

  if (!prNumber) {
    console.log('Not a pull_request event; skipping PR comment.')
    console.log(body)
    return
  }

  const [owner, repo] = (process.env.GITHUB_REPOSITORY || '').split('/')
  if (!owner || !repo) {
    console.log('GITHUB_REPOSITORY not set; cannot post comment')
    console.log(body)
    return
  }

  // Find existing comment with marker
  const listUrl = `https://api.github.com/repos/${owner}/${repo}/issues/${prNumber}/comments`
  if (!fetchLib) {
    console.error('No fetch implementation available (node-fetch not installed and global fetch missing); cannot post coverage comment')
    console.log(body)
    return
  }

  const listRes = await fetchLib(listUrl, { headers: { Authorization: `token ${token}`, 'User-Agent': 'coverage-script' } })
  const comments = await listRes.json()
  const existing = comments.find(c => c.body && c.body.includes('<!-- coverage-report -->'))

  if (existing) {
    const updateUrl = `https://api.github.com/repos/${owner}/${repo}/issues/comments/${existing.id}`
    await fetchLib(updateUrl, { method: 'PATCH', headers: { Authorization: `token ${token}`, 'User-Agent': 'coverage-script', 'Content-Type': 'application/json' }, body: JSON.stringify({ body }) })
    console.log('Updated existing coverage comment')
  } else {
    await fetchLib(listUrl, { method: 'POST', headers: { Authorization: `token ${token}`, 'User-Agent': 'coverage-script', 'Content-Type': 'application/json' }, body: JSON.stringify({ body }) })
    console.log('Posted new coverage comment')
  }
}

main().catch(err => { console.error(err); process.exit(1) })
